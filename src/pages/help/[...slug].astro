---
import type { GetStaticPaths } from 'astro';
import { getCollection, render } from 'astro:content';
import BaseLayout from '@layouts/BaseLayout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import HelpSidebar from '@components/HelpSidebar.astro';

export const getStaticPaths: GetStaticPaths = async () => {
  const helpEntries = await getCollection('help');
  return helpEntries
    .filter((entry) => entry.id !== 'index')
    .map((entry) => ({
      params: { slug: entry.id },
      props: { entry },
    }));
};

const { entry } = Astro.props;
const { Content, headings } = await render(entry);
const title = `${entry.data.title} â€” Viewpo Help`;
---

<BaseLayout title={title} description={entry.data.description}>
  <Header slot="header" />

  <section class="py-12 sm:py-16">
    <div class="container-wide">
      <div class="flex flex-col lg:flex-row gap-12">
        <!-- Sidebar (desktop) -->
        <aside class="hidden lg:block w-64 shrink-0">
          <div class="sticky top-24">
            <HelpSidebar currentSlug={entry.id} />
          </div>
        </aside>

        <!-- Main content -->
        <div class="flex-1 min-w-0">
          <!-- Mobile breadcrumb -->
          <nav class="lg:hidden mb-6 text-sm" aria-label="Breadcrumb">
            <a href="/help/" class="text-foreground/50 hover:text-foreground transition-colors">Help Centre</a>
            <span class="text-foreground/30 mx-2">/</span>
            <span class="text-foreground/70">{entry.data.title}</span>
          </nav>

          <!-- Table of contents (desktop, if enough headings) -->
          {headings.length > 3 && (
            <nav class="hidden xl:block float-right ml-8 mb-8 w-56 sticky top-24" aria-label="Table of contents">
              <p class="text-xs font-semibold text-foreground/40 uppercase tracking-wider mb-3">On this page</p>
              <ul class="space-y-2 text-sm border-l border-neutral-200 dark:border-neutral-800 pl-4">
                {headings
                  .filter((h) => h.depth <= 3)
                  .map((heading) => (
                    <li>
                      <a
                        href={`#${heading.slug}`}
                        class:list={[
                          'block text-foreground/50 hover:text-foreground transition-colors',
                          heading.depth === 3 && 'pl-3',
                        ]}
                      >
                        {heading.text}
                      </a>
                    </li>
                  ))}
              </ul>
            </nav>
          )}

          <!-- Article content -->
          <article class="help-content max-w-3xl">
            <h1 class="text-3xl sm:text-4xl font-heading font-bold text-foreground mb-8">
              {entry.data.title}
            </h1>
            <Content />
          </article>

          <!-- Previous / Next navigation -->
          <nav class="mt-16 pt-8 border-t border-neutral-200 dark:border-neutral-800 flex justify-between" aria-label="Help navigation">
            <a href="/help/" class="text-sm text-foreground/50 hover:text-foreground transition-colors">
              &larr; Back to Help Centre
            </a>
          </nav>
        </div>
      </div>
    </div>
  </section>

  <Footer slot="footer" />
</BaseLayout>

<style is:global>
  /* Markdown content styling for help articles */
  .help-content h2 {
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.5rem;
    margin-top: 2.5rem;
    margin-bottom: 1rem;
    color: var(--color-foreground);
  }

  .help-content h3 {
    font-family: var(--font-heading);
    font-weight: 600;
    font-size: 1.25rem;
    margin-top: 2rem;
    margin-bottom: 0.75rem;
    color: var(--color-foreground);
  }

  .help-content p {
    color: color-mix(in srgb, var(--color-foreground) 70%, transparent);
    line-height: 1.75;
    margin-bottom: 1rem;
  }

  .help-content a {
    color: var(--color-links);
    transition: color 0.15s;
  }

  .help-content a:hover {
    color: var(--color-primary);
  }

  .help-content ul,
  .help-content ol {
    color: color-mix(in srgb, var(--color-foreground) 70%, transparent);
    margin-bottom: 1rem;
    padding-left: 1.5rem;
  }

  .help-content ul {
    list-style: disc;
  }

  .help-content ol {
    list-style: decimal;
  }

  .help-content li {
    margin-bottom: 0.5rem;
    line-height: 1.75;
  }

  .help-content strong {
    color: var(--color-foreground);
    font-weight: 600;
  }

  .help-content blockquote {
    border-left: 3px solid var(--color-primary);
    padding: 0.75rem 1rem;
    margin: 1.5rem 0;
    background: color-mix(in srgb, var(--color-primary) 5%, transparent);
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .help-content blockquote p {
    margin-bottom: 0;
    color: var(--color-foreground);
  }

  .help-content table {
    width: 100%;
    margin: 1.5rem 0;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  .help-content thead th {
    text-align: left;
    padding: 0.75rem 1rem;
    font-weight: 600;
    color: var(--color-foreground);
    border-bottom: 2px solid color-mix(in srgb, var(--color-foreground) 10%, transparent);
  }

  .help-content tbody td {
    padding: 0.75rem 1rem;
    color: color-mix(in srgb, var(--color-foreground) 70%, transparent);
    border-bottom: 1px solid color-mix(in srgb, var(--color-foreground) 5%, transparent);
  }

  .help-content code {
    font-size: 0.875em;
    background: color-mix(in srgb, var(--color-foreground) 5%, transparent);
    padding: 0.125rem 0.375rem;
    border-radius: 0.25rem;
  }
</style>
