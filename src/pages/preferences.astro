---
import BaseLayout from '@layouts/BaseLayout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Section from '@components/Section.astro';
import { API_BASE_URL } from '@utils/constants';
---

<BaseLayout
  title="Email Preferences â€” Viewpo"
  description="Manage your Viewpo email subscription preferences."
>
  <Fragment slot="head">
    <meta name="robots" content="noindex, nofollow" />
  </Fragment>

  <Header slot="header" />

  <Section padding="lg">
    <div class="max-w-lg mx-auto py-12">
      <!-- Loading state -->
      <div id="pref-loading" class="text-center">
        <div class="inline-flex items-center justify-center w-12 h-12 mb-4">
          <svg class="w-8 h-8 animate-spin text-primary" viewBox="0 0 24 24" fill="none">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
        </div>
        <p class="text-foreground/60">Loading your preferences...</p>
      </div>

      <!-- Error state -->
      <div id="pref-error" class="hidden text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-red-50 dark:bg-red-900/20 rounded-full mb-6">
          <svg class="w-8 h-8 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
        </div>
        <h1 class="font-heading font-bold text-2xl mb-2">Invalid or expired link</h1>
        <p class="text-foreground/60 mb-6">This preferences link is no longer valid. You can find a new link in any recent email from Viewpo.</p>
        <a href="/" class="text-links hover:text-primary transition-colors underline underline-offset-2">Back to Viewpo</a>
      </div>

      <!-- Preferences form -->
      <div id="pref-form-container" class="hidden">
        <h1 class="font-heading font-bold text-2xl md:text-3xl mb-2 text-center">Email Preferences</h1>
        <p id="pref-email-display" class="text-foreground/60 text-center mb-8"></p>

        <div class="bg-white dark:bg-slate-800/50 border border-foreground/10 dark:border-white/10 rounded-2xl p-6 md:p-8">
          <h2 class="font-heading font-semibold text-lg mb-4">What would you like to receive?</h2>

          <div class="space-y-4">
            <label class="flex items-start gap-3 cursor-pointer group">
              <input type="checkbox" id="pref-marketing" class="mt-1 w-4 h-4 rounded border-foreground/20 text-primary focus:ring-primary" />
              <div>
                <span class="font-medium text-foreground group-hover:text-primary transition-colors">Marketing emails</span>
                <p class="text-foreground/50 text-sm">Product announcements, feature highlights, and tips</p>
              </div>
            </label>

            <label class="flex items-start gap-3 cursor-pointer group">
              <input type="checkbox" id="pref-product-updates" class="mt-1 w-4 h-4 rounded border-foreground/20 text-primary focus:ring-primary" />
              <div>
                <span class="font-medium text-foreground group-hover:text-primary transition-colors">Product updates</span>
                <p class="text-foreground/50 text-sm">Beta invites, new releases, and changelog updates</p>
              </div>
            </label>
          </div>

          <div class="flex flex-col sm:flex-row items-center gap-3 mt-8">
            <button
              type="button"
              id="pref-save"
              class="w-full sm:w-auto inline-flex items-center justify-center gap-2 bg-primary hover:bg-primary-hover text-white font-heading font-semibold px-6 py-3 rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Save Preferences
            </button>
            <button
              type="button"
              id="pref-unsubscribe"
              class="w-full sm:w-auto text-sm text-foreground/50 hover:text-red-500 transition-colors py-3 px-4"
            >
              Unsubscribe from all
            </button>
          </div>

          <div id="pref-status" class="hidden text-center text-sm py-2 px-3 rounded-lg mt-4" role="alert"></div>
        </div>
      </div>

      <!-- Unsubscribed state -->
      <div id="pref-unsubscribed" class="hidden text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-foreground/5 rounded-full mb-6">
          <svg class="w-8 h-8 text-foreground/40" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 9v.906a2.25 2.25 0 01-1.183 1.981l-6.478 3.488M2.25 9v.906a2.25 2.25 0 001.183 1.981l6.478 3.488m8.839 2.51l-4.66-2.51m0 0l-1.023-.55a2.25 2.25 0 00-2.134 0l-1.022.55m0 0l-4.661 2.51" />
          </svg>
        </div>
        <h2 class="font-heading font-bold text-2xl mb-2">You've been unsubscribed</h2>
        <p class="text-foreground/60 mb-6">You won't receive any more emails from Viewpo. Sorry to see you go.</p>
        <a href="/" class="text-links hover:text-primary transition-colors underline underline-offset-2">Back to Viewpo</a>
      </div>

      <!-- Saved state -->
      <div id="pref-saved" class="hidden text-center">
        <div class="inline-flex items-center justify-center w-16 h-16 bg-success/10 rounded-full mb-6">
          <svg class="w-8 h-8 text-success" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
          </svg>
        </div>
        <h2 class="font-heading font-bold text-2xl mb-2">Preferences saved</h2>
        <p class="text-foreground/60 mb-6">Your email preferences have been updated.</p>
        <a href="/" class="text-links hover:text-primary transition-colors underline underline-offset-2">Back to Viewpo</a>
      </div>
    </div>
  </Section>

  <Footer slot="footer" />
</BaseLayout>

<script define:vars={{ API_BASE_URL }}>
  function initPreferences() {
    const token = new URLSearchParams(window.location.search).get('token');

    const loadingEl = document.getElementById('pref-loading');
    const errorEl = document.getElementById('pref-error');
    const formContainer = document.getElementById('pref-form-container');
    const unsubscribedEl = document.getElementById('pref-unsubscribed');
    const savedEl = document.getElementById('pref-saved');
    const emailDisplay = document.getElementById('pref-email-display');
    const marketingCheckbox = document.getElementById('pref-marketing');
    const productCheckbox = document.getElementById('pref-product-updates');
    const saveBtn = document.getElementById('pref-save');
    const unsubBtn = document.getElementById('pref-unsubscribe');
    const statusEl = document.getElementById('pref-status');

    if (!token) {
      showState('error');
      return;
    }

    loadPreferences();

    async function loadPreferences() {
      try {
        const res = await fetch(`${API_BASE_URL}/api/preferences?token=${encodeURIComponent(token)}`);
        const data = await res.json();

        if (!data.success) {
          showState('error');
          return;
        }

        emailDisplay.textContent = `Managing preferences for ${data.email}`;
        marketingCheckbox.checked = data.consent?.marketing ?? false;
        productCheckbox.checked = data.consent?.product_updates ?? false;
        showState('form');
      } catch {
        showState('error');
      }
    }

    saveBtn?.addEventListener('click', async () => {
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';
      statusEl.classList.add('hidden');

      try {
        const res = await fetch(`${API_BASE_URL}/api/update-preferences`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            token,
            consent: {
              marketing: marketingCheckbox.checked,
              product_updates: productCheckbox.checked,
            },
          }),
        });

        const data = await res.json();
        if (data.success) {
          showState('saved');
        } else {
          showStatus(data.error || 'Failed to save preferences.', 'error');
        }
      } catch {
        showStatus('Network error. Please try again.', 'error');
      }

      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Preferences';
    });

    unsubBtn?.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to unsubscribe from all Viewpo emails?')) return;

      unsubBtn.disabled = true;
      unsubBtn.textContent = 'Unsubscribing...';

      try {
        await fetch(`${API_BASE_URL}/api/update-preferences`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, unsubscribe: true }),
        });

        showState('unsubscribed');
      } catch {
        showStatus('Network error. Please try again.', 'error');
        unsubBtn.disabled = false;
        unsubBtn.textContent = 'Unsubscribe from all';
      }
    });

    function showState(state) {
      loadingEl.classList.add('hidden');
      errorEl.classList.add('hidden');
      formContainer.classList.add('hidden');
      unsubscribedEl.classList.add('hidden');
      savedEl.classList.add('hidden');

      const el = {
        loading: loadingEl,
        error: errorEl,
        form: formContainer,
        unsubscribed: unsubscribedEl,
        saved: savedEl,
      }[state];

      el?.classList.remove('hidden');
    }

    function showStatus(message, type) {
      statusEl.textContent = message;
      statusEl.classList.remove('hidden', 'bg-red-50', 'text-red-700', 'dark:bg-red-900/20', 'dark:text-red-400');
      if (type === 'error') {
        statusEl.classList.add('bg-red-50', 'text-red-700', 'dark:bg-red-900/20', 'dark:text-red-400');
      }
    }
  }

  initPreferences();
  document.addEventListener('astro:after-swap', initPreferences);
</script>
