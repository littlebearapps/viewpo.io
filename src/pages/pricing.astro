---
import BaseLayout from '@layouts/BaseLayout.astro';
import Header from '@components/Header.astro';
import Footer from '@components/Footer.astro';
import Section from '@components/Section.astro';
import SectionHeader from '@components/SectionHeader.astro';
import Badge from '@components/Badge.astro';
import Card from '@components/Card.astro';
import FAQAccordion from '@components/FAQAccordion.svelte';
import { PRICING_TIERS, PRICING_COMPARISON, PRICING_FAQ_ITEMS } from '@utils/constants';

const title = 'Viewpo Pricing — Free, Starter & Pro Plans | Viewpo';
const description = 'Simple, transparent pricing for Viewpo. Start free with 3 projects. Upgrade to Starter at $9/month for unlimited projects and all providers. Pro team features coming soon.';

// Group comparison rows by category
const categories = [...new Set(PRICING_COMPARISON.map(r => r.category))];
---

<BaseLayout title={title} description={description}>
  <Header slot="header" />

  <div class="relative overflow-x-clip">
    <!-- Ambient glow -->
    <div class="pointer-events-none absolute inset-0" aria-hidden="true">
      <div class="absolute -top-40 -left-40 w-[600px] h-[600px] rounded-full bg-primary/15 blur-[160px] dark:bg-primary/[0.07]"></div>
      <div class="absolute top-[35%] right-[5%] w-[400px] h-[400px] rounded-full bg-indigo-300/10 blur-[130px] dark:bg-indigo-400/[0.05]"></div>
      <div class="absolute top-[70%] left-[20%] w-[450px] h-[450px] rounded-full bg-secondary/10 blur-[140px] dark:bg-secondary/[0.05]"></div>
    </div>

    <!-- Hero -->
    <section class="pt-16 sm:pt-24 pb-12 sm:pb-16">
      <div class="container-wide">
        <div class="max-w-2xl mx-auto text-center">
          <div class="hero-entrance">
            <Badge variant="default">Pricing</Badge>
          </div>
          <h1 class="font-heading font-bold text-3xl sm:text-4xl md:text-5xl text-foreground dark:text-white mt-4 mb-4 hero-entrance hero-entrance-delay-1">
            Simple, Transparent Pricing
          </h1>
          <p class="text-lg text-foreground/60 dark:text-neutral-400 leading-relaxed mb-2 hero-entrance hero-entrance-delay-2">
            Start free. Upgrade when you need more projects, providers, or team features.
          </p>
          <p class="text-sm text-foreground/40 dark:text-neutral-600 hero-entrance hero-entrance-delay-3">
            Prices in USD · Tax handled by Lemon Squeezy
          </p>
        </div>
      </div>
    </section>

    <!-- Pricing Cards -->
    <Section id="plans" padding="sm">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-5 max-w-5xl mx-auto items-stretch">
        {PRICING_TIERS.map((tier, i) => (
          <Card
            variant={tier.highlighted ? 'highlighted' : 'default'}
            class={`reveal reveal-delay-${i + 1} p-6 md:p-8 flex flex-col`}
          >
            {tier.highlighted && (
              <div class="absolute -top-3 left-1/2 -translate-x-1/2 z-10">
                <Badge variant="highlight" class="font-bold uppercase tracking-wider text-[11px]">
                  Most Popular
                </Badge>
              </div>
            )}

            <div class="mb-6">
              <h2 class="font-heading font-semibold text-lg mb-3 text-foreground dark:text-white">{tier.name}</h2>
              <div class="flex items-baseline gap-1.5 mb-2">
                <span class="font-mono font-bold text-4xl text-foreground dark:text-white">{tier.price}</span>
                <span class="text-foreground/40 dark:text-neutral-500 text-sm">{tier.period}</span>
              </div>
              <p class="text-foreground/50 dark:text-neutral-500 text-sm">{tier.description}</p>
            </div>

            <ul class="flex-1 space-y-3 mb-8">
              {tier.features.map((feature) => (
                <li class="flex items-start gap-2.5 text-sm">
                  <svg class="w-4 h-4 text-primary flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                  <span class="text-foreground/65 dark:text-neutral-400">{feature}</span>
                </li>
              ))}
            </ul>

            {tier.name === 'Free' ? (
              <a
                href="/beta/"
                class:list={[
                  'w-full justify-center inline-flex items-center gap-2 font-heading font-semibold rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 hover:scale-[1.02] active:scale-[0.98] px-6 py-3 text-sm',
                  'bg-primary text-white hover:bg-primary-hover focus:ring-primary shadow-md hover:shadow-lg',
                  `plausible-event-name=Pricing+${tier.name}`,
                ]}
              >
                {tier.cta}
              </a>
            ) : (
              <button
                type="button"
                data-open-signup="notify"
                class:list={[
                  'w-full justify-center inline-flex items-center gap-2 font-heading font-semibold rounded-xl transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-offset-2 hover:scale-[1.02] active:scale-[0.98] px-6 py-3 text-sm',
                  tier.highlighted
                    ? 'bg-primary text-white hover:bg-primary-hover focus:ring-primary shadow-md hover:shadow-lg'
                    : 'border border-neutral-300 dark:border-neutral-700 text-foreground dark:text-neutral-300 hover:bg-foreground/5 dark:hover:bg-white/5 focus:ring-primary/50',
                  `plausible-event-name=Pricing+${tier.name}`,
                ]}
              >
                {tier.cta}
              </button>
            )}
          </Card>
        ))}
      </div>
    </Section>

    <!-- Feature Comparison Table -->
    <Section id="compare" background="muted" padding="md">
      <SectionHeader
        title="Feature Comparison"
        subtitle="See exactly what's included in each plan."
      />

      <div class="overflow-x-auto -mx-6 px-6 reveal reveal-delay-1">
        <table class="w-full min-w-[560px] text-sm">
          <thead class="sticky top-16 z-10">
            <tr class="bg-muted dark:bg-neutral-800/80 backdrop-blur-sm border-b border-neutral-200 dark:border-neutral-700">
              <th class="text-left py-3 pr-4 font-heading font-semibold text-foreground dark:text-white w-[40%]">Feature</th>
              {PRICING_TIERS.map(tier => (
                <th class:list={['py-3 px-3 text-center font-heading font-semibold', tier.highlighted ? 'text-primary' : 'text-foreground/60 dark:text-neutral-400']}>
                  <div>{tier.name}</div>
                  <div class="font-mono text-xs font-normal mt-0.5 text-foreground/40 dark:text-neutral-500">
                    {tier.price}{tier.period !== 'forever' ? tier.period : ''}
                  </div>
                </th>
              ))}
            </tr>
          </thead>
          <tbody>
            {categories.map(category => (
              <>
                <tr>
                  <td colspan="4" class="pt-6 pb-2 px-0">
                    <span class="text-xs font-heading font-semibold uppercase tracking-wider text-foreground/40 dark:text-neutral-600">
                      {category}
                    </span>
                  </td>
                </tr>
                {PRICING_COMPARISON.filter(r => r.category === category).map(row => (
                  <tr class="border-b border-neutral-100 dark:border-neutral-800/50">
                    <td class="py-3 pr-4 text-foreground/70 dark:text-neutral-400">
                      {row.feature}
                      {row.note && (
                        <Badge variant="muted" class="ml-2 text-[10px] py-0">{row.note}</Badge>
                      )}
                    </td>
                    {([row.free, row.starter, row.pro] as (string | boolean)[]).map((val, vi) => (
                      <td class:list={['py-3 px-3 text-center', vi === 1 ? 'font-medium text-foreground dark:text-white' : 'text-foreground/50 dark:text-neutral-500']}>
                        {val === true ? (
                          <svg class:list={['w-5 h-5 mx-auto', vi === 1 ? 'text-emerald-500' : 'text-emerald-400/60']} fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                          </svg>
                        ) : val === false ? (
                          <span class="text-foreground/20 dark:text-neutral-700">&mdash;</span>
                        ) : (
                          <span class="text-sm">{val}</span>
                        )}
                      </td>
                    ))}
                  </tr>
                ))}
              </>
            ))}
          </tbody>
        </table>
      </div>
    </Section>

    <!-- Pricing FAQ -->
    <Section id="pricing-faq" padding="md">
      <SectionHeader
        title="Pricing Questions"
        subtitle="Everything you need to know about plans and billing."
      />

      <div class="max-w-3xl mx-auto reveal reveal-delay-2">
        <FAQAccordion items={PRICING_FAQ_ITEMS} client:visible />

        <div class="mt-10 text-center">
          <a
            href="/help/faq/"
            class="inline-flex items-center gap-2 font-heading font-semibold text-sm text-primary hover:text-primary-hover transition-colors group plausible-event-name=Pricing+FAQ+Read+All"
          >
            More questions? Read the full FAQ
            <svg class="w-4 h-4 transition-transform group-hover:translate-x-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>
      </div>
    </Section>

    <!-- CTA -->
    <Section id="pricing-cta" padding="lg">
      <div class="max-w-2xl mx-auto reveal">
        <div class="rounded-2xl border border-neutral-200 dark:border-neutral-700/50 bg-white/40 dark:bg-neutral-900/30 backdrop-blur-sm p-8 md:p-12 text-center relative overflow-hidden">
          <div class="absolute inset-0 bg-dot-pattern opacity-50 dark:opacity-30" aria-hidden="true"></div>
          <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[300px] h-[300px] rounded-full bg-primary/10 blur-[100px] dark:bg-primary/[0.05]" aria-hidden="true"></div>

          <div class="relative">
            <h2 class="font-heading font-bold text-2xl md:text-3xl text-foreground dark:text-white mb-3">
              Start for free
            </h2>
            <p class="text-foreground/60 dark:text-neutral-400 mb-6 max-w-md mx-auto">
              3 projects, 1 provider, and the viewport viewer with 6 presets. No credit card required.
            </p>
            <div class="flex flex-wrap items-center justify-center gap-3">
              <a
                href="/beta/"
                class="inline-flex items-center gap-2 bg-primary hover:bg-primary-hover text-white text-sm font-heading font-semibold px-6 py-3 rounded-xl transition-all hover:scale-[1.02] active:scale-[0.98] plausible-event-name=CTA+Pricing+Bottom+Join+Beta"
              >
                Join the Beta
              </a>
              <a
                href="/features/"
                class="inline-flex items-center gap-2 border border-neutral-300 dark:border-neutral-700 text-foreground dark:text-neutral-300 text-sm font-heading font-semibold px-6 py-3 rounded-xl transition-all hover:bg-foreground/5 dark:hover:bg-white/5 hover:scale-[1.02] active:scale-[0.98] plausible-event-name=CTA+Pricing+Bottom+Features"
              >
                Compare All Features
              </a>
            </div>
          </div>
        </div>
      </div>
    </Section>
  </div>

  <!-- FAQPage JSON-LD for pricing FAQs -->
  <script is:inline define:vars={{ pricingFAQs: PRICING_FAQ_ITEMS }}>
    const schema = {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "dateModified": new Date().toISOString().split('T')[0],
      "mainEntity": pricingFAQs.map((item) => ({
        "@type": "Question",
        "name": item.question,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": item.answer,
        },
      })),
    };
    const el = document.createElement('script');
    el.type = 'application/ld+json';
    el.textContent = JSON.stringify(schema);
    document.head.appendChild(el);
  </script>

  <Footer slot="footer" />
</BaseLayout>
