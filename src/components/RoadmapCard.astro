---
import type { RoadmapItem } from '@/lib/roadmap/types';

interface Props extends RoadmapItem {}

const { id, title, description, status, labels, checklistProgress, votes } = Astro.props;

const statusStyles = {
  planned: {
    border: 'from-primary/20 via-transparent to-primary/10',
  },
  'in-progress': {
    border: 'from-secondary/20 via-transparent to-secondary/10',
  },
  testing: {
    border: 'from-neutral-400/20 via-transparent to-neutral-400/10',
  },
  shipped: {
    border: 'from-success/20 via-transparent to-success/10',
  },
};

const labelColorMap: Record<string, string> = {
  blue: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-links',
  green: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
  orange: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  sky: 'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  black: 'bg-neutral-100 text-neutral-700 dark:bg-neutral-700/30 dark:text-neutral-300',
  purple: 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-300',
  lime: 'bg-lime-100 text-lime-700 dark:bg-lime-900/30 dark:text-lime-300',
  pink: 'bg-pink-100 text-pink-700 dark:bg-pink-900/30 dark:text-pink-300',
};

const s = statusStyles[status];
const labelNames = labels.map((l) => l.name).join(',');

// Encode item data as JSON for the drawer
const itemData = JSON.stringify({
  id,
  title,
  description,
  status,
  labels: labels.map((l) => ({ name: l.name, color: l.color })),
  checklistCompleted: checklistProgress?.completed,
  checklistTotal: checklistProgress?.total,
  votes,
});
---

<div
  class={`card-lift rounded-xl p-px bg-gradient-to-br ${s.border} cursor-pointer`}
  data-labels={labelNames}
  data-item-id={id}
  data-roadmap-card
  data-item-json={itemData}
  role="button"
  tabindex="0"
  aria-label={`${title}. Click for details.`}
>
  <div class="bg-white dark:bg-neutral-900/60 rounded-[11px] px-4 py-3 flex flex-col gap-2">
    <!-- Title -->
    <h3 class="font-heading font-semibold text-sm text-foreground line-clamp-2 leading-snug">{title}</h3>

    <!-- Bottom row: labels + vote -->
    <div class="flex items-center justify-between gap-2">
      <!-- Labels -->
      {labels.length > 0 ? (
        <div class="flex flex-wrap gap-1 min-w-0">
          {labels.slice(0, 2).map((label) => (
            <span class={`text-[11px] px-1.5 py-0.5 rounded-full font-medium truncate ${labelColorMap[label.color] ?? labelColorMap.blue}`}>
              {label.name}
            </span>
          ))}
        </div>
      ) : (
        <div></div>
      )}

      <!-- Vote button -->
      <button
        type="button"
        class="vote-btn inline-flex items-center gap-1 px-2 py-1 rounded-lg text-xs font-medium border border-neutral-200 dark:border-neutral-600 text-foreground/60 hover:border-primary hover:text-primary transition-all shrink-0"
        data-vote-btn
        data-item-id={id}
        data-vote-count={votes}
        aria-label={`Vote for ${title}. ${votes} votes.`}
        aria-pressed="false"
        onclick="event.stopPropagation();"
      >
        <svg class="w-3.5 h-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
        <span class="vote-count">{votes}</span>
      </button>
    </div>
  </div>
</div>
