---
import type { RoadmapItem } from '@/lib/roadmap/types';

interface Props extends RoadmapItem {}

const { id, title, description, status, labels, checklistProgress, votes } = Astro.props;

const statusStyles = {
  planned: {
    border: 'from-primary/20 via-transparent to-primary/10',
    dot: 'bg-primary',
    badge: 'bg-primary/10 text-primary dark:text-indigo-300',
    label: 'Planned',
  },
  'in-progress': {
    border: 'from-secondary/20 via-transparent to-secondary/10',
    dot: 'bg-secondary',
    badge: 'bg-secondary/10 text-secondary dark:text-orange-300',
    label: 'In Progress',
  },
  testing: {
    border: 'from-slate-400/20 via-transparent to-slate-400/10',
    dot: 'bg-slate-400',
    badge: 'bg-slate-400/10 text-slate-500 dark:text-slate-400',
    label: 'Testing',
  },
  shipped: {
    border: 'from-success/20 via-transparent to-success/10',
    dot: 'bg-success',
    badge: 'bg-success/10 text-success dark:text-emerald-300',
    label: 'Shipped',
  },
};

const labelColorMap: Record<string, string> = {
  blue: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300',
  green: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
  orange: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  sky: 'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  black: 'bg-slate-100 text-slate-700 dark:bg-slate-700/30 dark:text-slate-300',
};

const s = statusStyles[status];
const labelNames = labels.map((l) => l.name).join(',');
const progressPercent = checklistProgress
  ? Math.round((checklistProgress.completed / checklistProgress.total) * 100)
  : null;
---

<div
  class={`card-lift rounded-xl p-px bg-gradient-to-br ${s.border} h-full`}
  data-labels={labelNames}
  data-item-id={id}
>
  <div class="bg-white dark:bg-slate-800/80 rounded-[11px] p-5 h-full flex flex-col">
    <!-- Status badge -->
    <div class="flex items-center justify-between mb-3">
      <span class={`inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full text-xs font-medium ${s.badge}`}>
        <span class={`w-1.5 h-1.5 rounded-full ${s.dot}`}></span>
        {s.label}
      </span>
    </div>

    <!-- Title -->
    <h3 class="font-heading font-semibold text-base mb-2 text-foreground">{title}</h3>

    <!-- Description -->
    {description && (
      <p class="text-foreground/60 text-sm leading-relaxed mb-3 flex-1">{description}</p>
    )}

    <!-- Labels -->
    {labels.length > 0 && (
      <div class="flex flex-wrap gap-1.5 mb-3">
        {labels.map((label) => (
          <span class={`text-xs px-2 py-0.5 rounded-full font-medium ${labelColorMap[label.color] ?? labelColorMap.blue}`}>
            {label.name}
          </span>
        ))}
      </div>
    )}

    <!-- Checklist progress -->
    {checklistProgress && progressPercent !== null && (
      <div class="mb-3">
        <div class="flex items-center justify-between text-xs text-foreground/50 mb-1">
          <span>Progress</span>
          <span>{checklistProgress.completed}/{checklistProgress.total}</span>
        </div>
        <div class="h-1.5 bg-slate-200 dark:bg-slate-700 rounded-full overflow-hidden">
          <div
            class={`h-full rounded-full transition-all ${progressPercent === 100 ? 'bg-success' : 'bg-primary'}`}
            style={`width: ${progressPercent}%`}
          ></div>
        </div>
      </div>
    )}

    <!-- Vote button -->
    <div class="mt-auto pt-2 border-t border-slate-100 dark:border-slate-700/50">
      <button
        type="button"
        class="vote-btn inline-flex items-center gap-1.5 px-3 py-1.5 rounded-lg text-sm font-medium border border-slate-200 dark:border-slate-600 text-foreground/60 hover:border-primary hover:text-primary transition-all"
        data-vote-btn
        data-item-id={id}
        data-vote-count={votes}
        aria-label={`Vote for ${title}. ${votes} votes.`}
        aria-pressed="false"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
        <span class="vote-count">{votes}</span>
      </button>
    </div>
  </div>
</div>
