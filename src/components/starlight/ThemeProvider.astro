---
/**
 * Custom Starlight ThemeProvider override.
 * Bridges Viewpo's .dark class system with Starlight's data-theme attribute.
 * Uses Viewpo's 'theme' localStorage key as the source of truth.
 */
---

<script is:inline>
  window.StarlightThemeProvider = (() => {
    function applyTheme() {
      // Use Viewpo's localStorage key as source of truth
      const stored = typeof localStorage !== 'undefined' && localStorage.getItem('theme');
      const isDark = stored === 'dark' || (!stored && window.matchMedia('(prefers-color-scheme: dark)').matches);
      const theme = isDark ? 'dark' : 'light';

      // Set both Starlight's data-theme and Viewpo's .dark class
      document.documentElement.dataset.theme = theme;
      document.documentElement.classList.toggle('dark', isDark);
    }

    applyTheme();

    // Re-apply after Astro View Transitions
    document.addEventListener('astro:after-swap', applyTheme);

    return {
      updatePickers(theme) {
        // Sync pickers if any exist (Starlight ThemeSelect component)
        document.querySelectorAll('starlight-theme-select').forEach((picker) => {
          const select = picker.querySelector('select');
          if (select) select.value = theme || 'auto';
        });
      },
    };
  })();
</script>
