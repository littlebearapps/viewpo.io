---
/**
 * Slide-out detail panel for roadmap items.
 * Desktop: right-side panel. Mobile: bottom sheet.
 * Rendered once, populated dynamically via JS when a card is clicked.
 */

const labelColorMap: Record<string, string> = {
  blue: 'bg-indigo-100 text-indigo-700 dark:bg-indigo-900/30 dark:text-links',
  green: 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/30 dark:text-emerald-300',
  orange: 'bg-orange-100 text-orange-700 dark:bg-orange-900/30 dark:text-orange-300',
  sky: 'bg-sky-100 text-sky-700 dark:bg-sky-900/30 dark:text-sky-300',
  black: 'bg-neutral-100 text-neutral-700 dark:bg-neutral-700/30 dark:text-neutral-300',
};

const statusStyles: Record<string, { dot: string; badge: string; label: string }> = {
  planned: { dot: 'bg-primary', badge: 'bg-primary/10 text-primary dark:text-links', label: 'Planned' },
  'in-progress': { dot: 'bg-secondary', badge: 'bg-secondary/10 text-secondary dark:text-orange-300', label: 'In Progress' },
  testing: { dot: 'bg-neutral-400', badge: 'bg-neutral-400/10 text-neutral-500 dark:text-neutral-400', label: 'Testing' },
  shipped: { dot: 'bg-success', badge: 'bg-success/10 text-success dark:text-emerald-300', label: 'Shipped' },
};
---

<!-- Backdrop -->
<div
  id="roadmap-drawer-backdrop"
  class="fixed inset-0 z-40 bg-black/50 backdrop-blur-sm opacity-0 pointer-events-none transition-opacity duration-300"
  aria-hidden="true"
></div>

<!-- Drawer panel -->
<aside
  id="roadmap-drawer"
  class="fixed z-50 bg-white dark:bg-neutral-900 shadow-2xl transition-transform duration-300 ease-out
    inset-x-0 bottom-0 max-h-[85vh] rounded-t-2xl translate-y-full
    md:inset-y-0 md:right-0 md:left-auto md:bottom-auto md:max-h-none md:w-[420px] md:rounded-t-none md:rounded-l-2xl md:translate-y-0 md:translate-x-full"
  role="dialog"
  aria-modal="true"
  aria-labelledby="drawer-title"
  aria-hidden="true"
>
  <!-- Drag handle (mobile only) -->
  <div class="flex justify-center pt-3 pb-1 md:hidden">
    <div class="w-10 h-1 rounded-full bg-neutral-300 dark:bg-neutral-600"></div>
  </div>

  <div class="overflow-y-auto h-full p-6 pb-8">
    <!-- Close button -->
    <button
      type="button"
      id="drawer-close"
      class="absolute top-4 right-4 p-2 rounded-lg text-foreground/40 hover:text-foreground hover:bg-foreground/5 transition-colors"
      aria-label="Close detail panel"
    >
      <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
      </svg>
    </button>

    <!-- Status badge -->
    <div id="drawer-status" class="mb-4">
      <!-- Populated by JS -->
    </div>

    <!-- Title -->
    <h2 id="drawer-title" class="font-heading font-bold text-xl md:text-2xl text-foreground mb-4 pr-8">
      <!-- Populated by JS -->
    </h2>

    <!-- Labels -->
    <div id="drawer-labels" class="flex flex-wrap gap-1.5 mb-5">
      <!-- Populated by JS -->
    </div>

    <!-- Description -->
    <div id="drawer-description" class="text-foreground/70 text-sm leading-relaxed mb-6">
      <!-- Populated by JS -->
    </div>

    <!-- Checklist progress -->
    <div id="drawer-progress" class="mb-6 hidden">
      <div class="flex items-center justify-between text-sm text-foreground/60 mb-2">
        <span class="font-medium">Progress</span>
        <span id="drawer-progress-count"></span>
      </div>
      <div class="h-2 bg-neutral-200 dark:bg-neutral-700 rounded-full overflow-hidden">
        <div id="drawer-progress-bar" class="h-full rounded-full transition-all bg-primary"></div>
      </div>
    </div>

    <!-- Vote button -->
    <div id="drawer-vote" class="pt-4 border-t border-neutral-100 dark:border-neutral-700/50">
      <button
        type="button"
        id="drawer-vote-btn"
        class="inline-flex items-center gap-2 px-4 py-2.5 rounded-xl text-sm font-semibold border border-neutral-200 dark:border-neutral-600 text-foreground/60 hover:border-primary hover:text-primary transition-all"
        data-vote-btn
        aria-pressed="false"
      >
        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" />
        </svg>
        <span>Vote</span>
        <span class="vote-count" id="drawer-vote-count">0</span>
      </button>
    </div>
  </div>
</aside>

<script define:vars={{ labelColorMap, statusStyles }}>
  function initRoadmapDrawer() {
    const drawer = document.getElementById('roadmap-drawer');
    const backdrop = document.getElementById('roadmap-drawer-backdrop');
    const closeBtn = document.getElementById('drawer-close');
    const titleEl = document.getElementById('drawer-title');
    const statusEl = document.getElementById('drawer-status');
    const labelsEl = document.getElementById('drawer-labels');
    const descEl = document.getElementById('drawer-description');
    const progressEl = document.getElementById('drawer-progress');
    const progressCount = document.getElementById('drawer-progress-count');
    const progressBar = document.getElementById('drawer-progress-bar');
    const voteBtn = document.getElementById('drawer-vote-btn');
    const voteCount = document.getElementById('drawer-vote-count');

    if (!drawer || !backdrop) return;

    let isOpen = false;
    let currentItemId = null;

    function open(itemData) {
      currentItemId = itemData.id;

      // Title
      titleEl.textContent = itemData.title;

      // Status badge
      const s = statusStyles[itemData.status] || statusStyles.planned;
      statusEl.innerHTML = `<span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full text-xs font-medium ${s.badge}"><span class="w-1.5 h-1.5 rounded-full ${s.dot}"></span>${s.label}</span>`;

      // Labels
      if (itemData.labels && itemData.labels.length > 0) {
        labelsEl.innerHTML = itemData.labels.map(function(l) {
          const cls = labelColorMap[l.color] || labelColorMap.blue;
          return '<span class="text-xs px-2.5 py-0.5 rounded-full font-medium ' + cls + '">' + l.name + '</span>';
        }).join('');
        labelsEl.classList.remove('hidden');
      } else {
        labelsEl.classList.add('hidden');
      }

      // Description
      if (itemData.description) {
        descEl.textContent = itemData.description;
        descEl.classList.remove('hidden');
      } else {
        descEl.classList.add('hidden');
      }

      // Checklist progress
      if (itemData.checklistCompleted !== undefined && itemData.checklistTotal) {
        const pct = Math.round((itemData.checklistCompleted / itemData.checklistTotal) * 100);
        progressCount.textContent = itemData.checklistCompleted + '/' + itemData.checklistTotal;
        progressBar.style.width = pct + '%';
        progressBar.className = 'h-full rounded-full transition-all ' + (pct === 100 ? 'bg-success' : 'bg-primary');
        progressEl.classList.remove('hidden');
      } else {
        progressEl.classList.add('hidden');
      }

      // Vote state — sync from the card's vote button
      const cardVoteBtn = document.querySelector('[data-item-id="' + itemData.id + '"][data-vote-btn]');
      if (cardVoteBtn) {
        const count = cardVoteBtn.querySelector('.vote-count');
        voteCount.textContent = count ? count.textContent : '0';
        voteBtn.dataset.itemId = itemData.id;

        // Copy voted state
        if (cardVoteBtn.getAttribute('aria-pressed') === 'true') {
          voteBtn.classList.remove('border-neutral-200', 'dark:border-neutral-600', 'text-foreground/60', 'hover:border-primary', 'hover:text-primary');
          voteBtn.classList.add('bg-primary/10', 'border-primary/30', 'text-primary');
          voteBtn.setAttribute('aria-pressed', 'true');
        } else {
          voteBtn.classList.add('border-neutral-200', 'dark:border-neutral-600', 'text-foreground/60', 'hover:border-primary', 'hover:text-primary');
          voteBtn.classList.remove('bg-primary/10', 'border-primary/30', 'text-primary');
          voteBtn.setAttribute('aria-pressed', 'false');
        }
      }

      // Show drawer
      isOpen = true;
      drawer.setAttribute('aria-hidden', 'false');
      backdrop.classList.remove('opacity-0', 'pointer-events-none');
      backdrop.classList.add('opacity-100');
      document.body.style.overflow = 'hidden';

      // Animate in — mobile: slide up, desktop: slide left
      requestAnimationFrame(function() {
        drawer.classList.remove('translate-y-full', 'md:translate-x-full');
        drawer.classList.add('translate-y-0', 'md:translate-x-0');
      });

      // Focus close button
      closeBtn.focus();
    }

    function close() {
      if (!isOpen) return;
      isOpen = false;

      drawer.classList.add('translate-y-full', 'md:translate-x-full');
      drawer.classList.remove('translate-y-0', 'md:translate-x-0');
      backdrop.classList.add('opacity-0', 'pointer-events-none');
      backdrop.classList.remove('opacity-100');
      document.body.style.overflow = '';

      setTimeout(function() {
        drawer.setAttribute('aria-hidden', 'true');
      }, 300);

      // Return focus to the card that opened the drawer
      if (currentItemId) {
        const card = document.querySelector('[data-item-id="' + currentItemId + '"][data-roadmap-card]');
        if (card) card.focus();
      }
      currentItemId = null;
    }

    // Close handlers
    closeBtn.addEventListener('click', close);
    backdrop.addEventListener('click', close);

    // Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape' && isOpen) {
        e.preventDefault();
        close();
      }
    });

    // Drawer vote button — delegate to the card's existing vote logic
    voteBtn.addEventListener('click', function() {
      const itemId = voteBtn.dataset.itemId;
      if (!itemId) return;
      const cardVoteBtn = document.querySelector('[data-item-id="' + itemId + '"][data-vote-btn]');
      if (cardVoteBtn) {
        cardVoteBtn.click();
        // Sync state back after a tick
        setTimeout(function() {
          const count = cardVoteBtn.querySelector('.vote-count');
          voteCount.textContent = count ? count.textContent : '0';
          if (cardVoteBtn.getAttribute('aria-pressed') === 'true') {
            voteBtn.classList.remove('border-neutral-200', 'dark:border-neutral-600', 'text-foreground/60', 'hover:border-primary', 'hover:text-primary');
            voteBtn.classList.add('bg-primary/10', 'border-primary/30', 'text-primary');
            voteBtn.setAttribute('aria-pressed', 'true');
          }
        }, 100);
      }
    });

    // Expose open function globally for cards to call
    window.__roadmapDrawer = { open: open, close: close };
  }

  initRoadmapDrawer();
  document.addEventListener('astro:after-swap', initRoadmapDrawer);
</script>
