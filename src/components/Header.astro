---
import ThemeToggle from './ThemeToggle.astro';

const simpleLinks = [
  { label: 'Features', href: '/#features' },
  { label: 'Pricing', href: '/#pricing' },
];

const useCasePersonas = [
  { label: 'Remote Developers', href: '/use-cases/remote-monitoring/' },
  { label: 'Indie Founders', href: '/use-cases/indie-hackers/' },
  { label: 'Creators', href: '/use-cases/creators/' },
  { label: 'Freelancers', href: '/use-cases/freelancers/' },
  { label: 'Agencies', href: '/use-cases/agencies/' },
  { label: 'Team Leads', href: '/use-cases/teams/' },
  { label: 'QA & Design', href: '/use-cases/qa-design/' },
];

const useCaseSituations = [
  { label: 'Client Feedback', href: '/use-cases/client-feedback/' },
  { label: 'Team Review', href: '/use-cases/team-review/' },
  { label: 'iPad Testing', href: '/use-cases/ipad-testing/' },
  { label: 'Responsive Testing', href: '/use-cases/responsive-testing/' },
  { label: 'Production Monitoring', href: '/use-cases/production-monitoring/' },
  { label: 'Live Demos', href: '/use-cases/live-demos/' },
];

const dropdowns = [
  {
    label: 'Use Cases',
    items: [
      ...useCasePersonas,
      ...useCaseSituations,
    ],
  },
  {
    label: 'Help',
    items: [
      { label: 'Getting Started', href: '/help/getting-started/' },
      { label: 'FAQ', href: '/help/faq/' },
      { label: 'Contact Us', href: '/help/contact/' },
    ],
  },
];

// Flat list for mobile menu (used by mobile nav rendering above)
const mobileLinks = [
  { label: 'Features', href: '/#features' },
  { label: 'Pricing', href: '/#pricing' },
  ...useCasePersonas,
  ...useCaseSituations,
  { label: 'Getting Started', href: '/help/getting-started/' },
  { label: 'FAQ', href: '/help/faq/' },
  { label: 'Contact Us', href: '/help/contact/' },
];
---

<header class="sticky top-0 z-50 backdrop-blur-md bg-background/80 dark:bg-dark-bg/80 border-b border-neutral-200 dark:border-neutral-800">
  <div class="container-wide flex items-center justify-between h-16">
    <!-- Logo -->
    <a href="/" class="flex items-center gap-2 font-heading font-bold text-xl text-foreground">
      <img src="/viewpo-icon.svg" alt="" width="28" height="28" class="w-7 h-7 rounded-md" />
      Viewpo
    </a>

    <!-- Desktop Nav -->
    <nav class="hidden md:flex items-center gap-8" aria-label="Main navigation">
      <!-- Features -->
      <a href="/#features" class="text-sm font-medium text-foreground/70 hover:text-foreground transition-colors plausible-event-name=Nav+Features">
        Features
      </a>

      <!-- Use Cases dropdown (categorised) -->
      <div class="relative" data-dropdown>
        <button
          type="button"
          class="flex items-center gap-1 text-sm font-medium text-foreground/70 hover:text-foreground transition-colors bg-transparent border-none p-0 cursor-pointer plausible-event-name=Nav+UseCases"
          aria-expanded="false"
          aria-haspopup="true"
        >
          Use Cases
          <svg class="w-3.5 h-3.5 opacity-50 transition-transform duration-200" data-dropdown-chevron fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div class="absolute top-full left-1/2 -translate-x-1/2 pt-2 hidden" data-dropdown-menu>
          <div class="bg-background dark:bg-dark-bg border border-neutral-200 dark:border-neutral-800 rounded-xl shadow-lg p-4 min-w-[320px]">
            <div class="grid grid-cols-2 gap-4">
              <!-- Who It's For -->
              <div>
                <p class="text-[11px] font-medium text-foreground/40 uppercase tracking-wider mb-2 px-1">Who It's For</p>
                {useCasePersonas.map(({ label, href }) => (
                  <a href={href} class={`block px-2 py-1.5 text-sm text-foreground/70 hover:text-foreground hover:bg-foreground/5 rounded-md transition-colors plausible-event-name=Nav+${label.replace(/\s+/g, '+')}`}>
                    {label}
                  </a>
                ))}
              </div>
              <!-- When You Need It -->
              <div>
                <p class="text-[11px] font-medium text-foreground/40 uppercase tracking-wider mb-2 px-1">When You Need It</p>
                {useCaseSituations.map(({ label, href }) => (
                  <a href={href} class={`block px-2 py-1.5 text-sm text-foreground/70 hover:text-foreground hover:bg-foreground/5 rounded-md transition-colors plausible-event-name=Nav+${label.replace(/\s+/g, '+')}`}>
                    {label}
                  </a>
                ))}
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Pricing -->
      <a href="/#pricing" class="text-sm font-medium text-foreground/70 hover:text-foreground transition-colors plausible-event-name=Nav+Pricing">
        Pricing
      </a>

      <!-- Roadmap -->
      <a href="/roadmap/" class="text-sm font-medium text-foreground/70 hover:text-foreground transition-colors plausible-event-name=Nav+Roadmap">
        Roadmap
      </a>

      <!-- Help dropdown -->
      <div class="relative" data-dropdown>
        <a
          href="/help/"
          class="flex items-center gap-1 text-sm font-medium text-foreground/70 hover:text-foreground transition-colors plausible-event-name=Nav+Help"
          aria-expanded="false"
          aria-haspopup="true"
          role="button"
        >
          Help
          <svg class="w-3.5 h-3.5 opacity-50 transition-transform duration-200" data-dropdown-chevron fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
          </svg>
        </a>
        <div class="absolute top-full left-1/2 -translate-x-1/2 pt-2 hidden" data-dropdown-menu>
          <div class="bg-background dark:bg-dark-bg border border-neutral-200 dark:border-neutral-800 rounded-lg shadow-lg py-1.5 min-w-[180px]">
            <a href="/help/" class="block px-4 py-2 text-sm text-foreground/70 hover:text-foreground hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Help+Centre">
              Help Centre
            </a>
            {dropdowns[1].items.map(({ label, href }) => (
              <a href={href} class={`block px-4 py-2 text-sm text-foreground/70 hover:text-foreground hover:bg-foreground/5 transition-colors plausible-event-name=Nav+${label.replace(/\s+/g, '+')}`}>
                {label}
              </a>
            ))}
          </div>
        </div>
      </div>
    </nav>

    <!-- Actions -->
    <div class="flex items-center gap-3">
      <ThemeToggle />
      <button
        type="button"
        data-open-signup
        class="hidden sm:inline-flex items-center gap-2 bg-primary hover:bg-primary-hover text-white text-sm font-heading font-medium px-4 py-2 rounded-lg transition-all hover:scale-[1.02] active:scale-[0.98] plausible-event-name=CTA+Header+Join+Beta"
      >
        Join the Beta
      </button>

      <!-- Mobile menu button -->
      <button
        id="mobile-menu-btn"
        class="md:hidden p-2 rounded-lg text-foreground/60 hover:text-foreground hover:bg-foreground/5 transition-colors"
        aria-label="Open menu"
        aria-expanded="false"
      >
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
      </button>
    </div>
  </div>

  <!-- Mobile Nav -->
  <nav
    id="mobile-menu"
    class="hidden md:hidden border-t border-neutral-200 dark:border-neutral-800 bg-background dark:bg-dark-bg"
    aria-label="Mobile navigation"
  >
    <div class="container-wide py-4 flex flex-col gap-1">
      <!-- Use Cases group -->
      <p class="text-xs font-medium text-foreground/40 uppercase tracking-wider pt-2 pb-1 px-2">Product</p>
      <a href="/#features" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Features">
        Features
      </a>
      <a href="/#pricing" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Pricing">
        Pricing
      </a>
      <a href="/roadmap/" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Roadmap">
        Roadmap
      </a>

      <p class="text-xs font-medium text-foreground/40 uppercase tracking-wider pt-4 pb-1 px-2">Who It's For</p>
      {useCasePersonas.map(({ label, href }) => (
        <a href={href} class={`text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+${label.replace(/\s+/g, '+')}`}>
          {label}
        </a>
      ))}

      <p class="text-xs font-medium text-foreground/40 uppercase tracking-wider pt-4 pb-1 px-2">When You Need It</p>
      {useCaseSituations.map(({ label, href }) => (
        <a href={href} class={`text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+${label.replace(/\s+/g, '+')}`}>
          {label}
        </a>
      ))}

      <p class="text-xs font-medium text-foreground/40 uppercase tracking-wider pt-4 pb-1 px-2">Help</p>
      <a href="/help/" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Help+Centre">
        Help Centre
      </a>
      <a href="/help/getting-started/" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Getting+Started">
        Getting Started
      </a>
      <a href="/help/faq/" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+FAQ">
        FAQ
      </a>
      <a href="/help/contact/" class="text-base font-medium text-foreground/70 hover:text-foreground py-2 px-2 rounded-lg hover:bg-foreground/5 transition-colors plausible-event-name=Nav+Contact">
        Contact Us
      </a>

      <div class="pt-4">
        <button
          type="button"
          data-open-signup
          class="inline-flex items-center justify-center w-full bg-primary hover:bg-primary-hover text-white text-sm font-heading font-medium px-4 py-2.5 rounded-lg transition-all plausible-event-name=CTA+Header+Join+Beta"
        >
          Join the Beta
        </button>
      </div>
    </div>
  </nav>
</header>

<script>
  function initMobileMenu(): void {
    const btn = document.getElementById('mobile-menu-btn');
    const menu = document.getElementById('mobile-menu');
    if (!btn || !menu) return;

    btn.addEventListener('click', () => {
      const isOpen = !menu.classList.contains('hidden');
      menu.classList.toggle('hidden');
      btn.setAttribute('aria-expanded', String(!isOpen));
    });

    // Close mobile menu when clicking a link
    menu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        menu.classList.add('hidden');
        btn.setAttribute('aria-expanded', 'false');
      });
    });
  }

  function initDropdowns(): void {
    document.querySelectorAll('[data-dropdown]').forEach((dropdown) => {
      const trigger = dropdown.querySelector<HTMLElement>('[aria-haspopup]');
      const menu = dropdown.querySelector('[data-dropdown-menu]');
      const chevron = dropdown.querySelector('[data-dropdown-chevron]');
      if (!trigger || !menu) return;

      // Toggle on click (prevent navigation for link triggers)
      trigger.addEventListener('click', (e) => {
        e.stopPropagation();
        // If already open, let link triggers navigate; if closed, show dropdown
        const isOpen = !menu.classList.contains('hidden');
        if (!isOpen) {
          e.preventDefault();
        }

        // Close all other dropdowns first
        document.querySelectorAll('[data-dropdown]').forEach((other) => {
          if (other !== dropdown) {
            other.querySelector('[data-dropdown-menu]')?.classList.add('hidden');
            other.querySelector<HTMLElement>('[aria-haspopup]')?.setAttribute('aria-expanded', 'false');
            (other.querySelector('[data-dropdown-chevron]') as HTMLElement | null)?.style.removeProperty('transform');
          }
        });

        menu.classList.toggle('hidden');
        trigger.setAttribute('aria-expanded', String(!isOpen));
        if (chevron) {
          (chevron as HTMLElement).style.transform = isOpen ? '' : 'rotate(180deg)';
        }
      });

      // Show on hover (desktop)
      let hoverTimeout: ReturnType<typeof setTimeout>;
      dropdown.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
        menu.classList.remove('hidden');
        trigger.setAttribute('aria-expanded', 'true');
        if (chevron) {
          (chevron as HTMLElement).style.transform = 'rotate(180deg)';
        }
      });

      dropdown.addEventListener('mouseleave', () => {
        hoverTimeout = setTimeout(() => {
          menu.classList.add('hidden');
          trigger.setAttribute('aria-expanded', 'false');
          if (chevron) {
            (chevron as HTMLElement).style.removeProperty('transform');
          }
        }, 150);
      });
    });

    // Close dropdowns when clicking outside
    document.addEventListener('click', () => {
      document.querySelectorAll('[data-dropdown]').forEach((dropdown) => {
        dropdown.querySelector('[data-dropdown-menu]')?.classList.add('hidden');
        dropdown.querySelector<HTMLElement>('[aria-haspopup]')?.setAttribute('aria-expanded', 'false');
        const chevron = dropdown.querySelector('[data-dropdown-chevron]') as HTMLElement | null;
        if (chevron) chevron.style.removeProperty('transform');
      });
    });
  }

  initMobileMenu();
  initDropdowns();
  document.addEventListener('astro:after-swap', () => {
    initMobileMenu();
    initDropdowns();
  });
</script>
